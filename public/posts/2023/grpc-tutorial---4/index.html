<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>gRPC tutorial - 4: Client Streaming | iHelio</title>
<meta name="keywords" content="">
<meta name="description" content="We will implement a function to upload image when we create the books like the cover and something else. And we would split the image into chunks and we upload them chunk by chunk until all data are transfered. As we defined earlier in the proto, we could have multiple images for one book. So we will need a function called uploadImage and uploade all images one by one.
Let&rsquo;s start with the proto of image:">
<meta name="author" content="Me">
<link rel="canonical" href="//localhost:1313/posts/2023/grpc-tutorial---4/">
<meta name="google-site-verification" content="XYZabc">
<meta name="yandex-verification" content="XYZabc">
<meta name="msvalidate.01" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="//localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="//localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//localhost:1313/posts/2023/grpc-tutorial---4/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-R4SSGN5Y2Z"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-R4SSGN5Y2Z');
        }
      </script><meta property="og:url" content="//localhost:1313/posts/2023/grpc-tutorial---4/">
  <meta property="og:site_name" content="iHelio">
  <meta property="og:title" content="gRPC tutorial - 4: Client Streaming">
  <meta property="og:description" content="We will implement a function to upload image when we create the books like the cover and something else. And we would split the image into chunks and we upload them chunk by chunk until all data are transfered. As we defined earlier in the proto, we could have multiple images for one book. So we will need a function called uploadImage and uploade all images one by one.
Let’s start with the proto of image:">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-16T16:17:15-04:00">
    <meta property="article:modified_time" content="2023-09-16T16:17:15-04:00">
      <meta property="og:image" content="//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:title" content="gRPC tutorial - 4: Client Streaming">
<meta name="twitter:description" content="We will implement a function to upload image when we create the books like the cover and something else. And we would split the image into chunks and we upload them chunk by chunk until all data are transfered. As we defined earlier in the proto, we could have multiple images for one book. So we will need a function called uploadImage and uploade all images one by one.
Let&rsquo;s start with the proto of image:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "//localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "gRPC tutorial - 4: Client Streaming",
      "item": "//localhost:1313/posts/2023/grpc-tutorial---4/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "gRPC tutorial - 4: Client Streaming",
  "name": "gRPC tutorial - 4: Client Streaming",
  "description": "We will implement a function to upload image when we create the books like the cover and something else. And we would split the image into chunks and we upload them chunk by chunk until all data are transfered. As we defined earlier in the proto, we could have multiple images for one book. So we will need a function called uploadImage and uploade all images one by one.\nLet\u0026rsquo;s start with the proto of image:\n",
  "keywords": [
    
  ],
  "articleBody": "We will implement a function to upload image when we create the books like the cover and something else. And we would split the image into chunks and we upload them chunk by chunk until all data are transfered. As we defined earlier in the proto, we could have multiple images for one book. So we will need a function called uploadImage and uploade all images one by one.\nLet’s start with the proto of image:\nsyntax = \"proto3\"; package book; option java_multiple_files = true; option java_package = \"today.ihelio.grpc\"; import \"google/protobuf/timestamp.proto\"; message Image { string id = 1; string file_path = 2; string size = 3; google.protobuf.Timestamp uploaded_at = 4; } We create an Image message which has four fields: image id, file path in local, size and timestamp. This will be used on server side to contain the image info when it receives an image from client.\nThen we need define our request and response for client.\nmessage UploadImageRequest { oneof data { ImageInfo info = 1; bytes chunk_data = 2; } } message ImageInfo { string book_id = 1; string image_type = 2; string file_name = 3; } message UploadImageResponse { string id = 1; uint32 size = 2; string file_path = 3; } We define an ImageInfo message which will contain book_id it associates with, image type and name. Thus the UploadImageRequest would upload the info to the server in addition to the image itself. Then the UploadImageResponse would return the server-generated id, size and file path at server.\nThus the BookService now is:\nservice BookService { rpc CreateBook(CreateBookRequest) returns (CreateBookResponse) {}; rpc UploadImage(stream UploadImageRequest) returns (UploadImageResponse) {}; } Now we should turn to the implmentation of UploadImage in server, client and service. Since we already have them, we will now build upon them.\nBookService always comes the first since it is our core logic. With core logic built up, it is easy to implement server and client for it. And it is easy to add new feature to BookService given we just need use the auto code generation function in Intellij and insert the Override Method which is uploadImage in this case.\n@Override public StreamObserver\u003cUploadImageRequest\u003e uploadImage(StreamObserver\u003cUploadImageResponse\u003e responseObserver) { return new StreamObserver\u003cUploadImageRequest\u003e() { private String bookID; private ImageInfo info; private ByteArrayOutputStream imageData; @Override public void onNext(UploadImageRequest request) { if (request.getDataCase() == UploadImageRequest.DataCase.INFO) { info = request.getInfo(); logger.info(\"receive image info:\\n\" + info); bookID = info.getBookId(); imageData = new ByteArrayOutputStream(); Book found = bookStore.findBook(bookID); if (found == null) { responseObserver.onError( Status.NOT_FOUND .withDescription(\"Book not found\") .asRuntimeException() ); } return; } ByteString chunkData = request.getChunkData(); if (imageData == null) { logger.info(\"image info wasn't sent before\"); responseObserver.onError( Status.INVALID_ARGUMENT .withDescription(\"image info wasn't sent before\") .asRuntimeException() ); return; } try { chunkData.writeTo(imageData); } catch (IOException e) { responseObserver.onError( Status.INTERNAL .withDescription(\"cannot write chunk data: \" + e.getMessage()) .asRuntimeException()); } } @Override public void onError(Throwable t) { logger.warning(t.getMessage()); } @Override public void onCompleted() { String imageID = \"\"; int imageSize = imageData.size(); try { imageID = imageStore.Save(bookID, info, imageData); } catch (IOException e) { throw new RuntimeException(e); } UploadImageResponse response = UploadImageResponse.newBuilder() .setId(imageID) .setSize(imageSize) .build(); responseObserver.onNext(response); responseObserver.onCompleted(); } }; } Same as alwasys, the key is to return what we need return which is StreamObserver, thus we could directly return a new StreamObserver and put our logic inside the code block.\nAnd there are three function we need fill:\nOnNext: continously handle the next request Create ByteArrayOutputStream to save the image data Check if the upload data type is ImageInfo If yes, we store the image info, otherwise we write the data chunk to ByteArrayOutputStream OnError: Handle the error OnCompleted: Save the image to our image store (we will talk about it later) Send out the response Close the response After we have the logic ready, we then can start client and server implementation.\nThe following snippet is the implmenetation of uploadImage from client:\npublic void uploadImage(String bookID, Image image) throws InterruptedException { final CountDownLatch latch = new CountDownLatch(1); // we use asyncStub instead of blockingStub for streaming connection StreamObserver\u003cUploadImageRequest\u003e requestObserver = asyncStub.withDeadlineAfter(5, SECONDS) .uploadImage(new StreamObserver\u003cUploadImageResponse\u003e() { @Override public void onNext(UploadImageResponse response) { logger.info(\"receive response:\\n\" + response); } @Override public void onError(Throwable t) { logger.log(SEVERE, \"upload failed: \" + t); latch.countDown(); } @Override public void onCompleted() { logger.info(\"image uploaded\"); latch.countDown(); } }); FileInputStream fileInputStream; String imagePath; try { imagePath = image.getFilePath(); fileInputStream = new FileInputStream(imagePath); } catch (FileNotFoundException e) { logger.log(SEVERE, \"cannot read image file: \" + e.getMessage()); return; } String imageType = imagePath.substring(imagePath.lastIndexOf(\".\")); String fileName = imagePath.substring(imagePath.lastIndexOf(\"/\")); ImageInfo info = ImageInfo.newBuilder() .setBookId(bookID) .setImageType(imageType) .setFileName(fileName) .build(); UploadImageRequest request = UploadImageRequest.newBuilder().setInfo(info).build(); try { requestObserver.onNext(request); logger.info(\"send image info:\\n\" + info); byte[] buffer = new byte[1024]; while (true) { int n = fileInputStream.read(buffer); if (n \u003c= 0) { break; } if (latch.getCount() == 0) { return; } request = UploadImageRequest.newBuilder() .setChunkData(ByteString.copyFrom(buffer)) .build(); requestObserver.onNext(request); } } catch (Exception e) { logger.log(SEVERE, \"unexpected error: \" + e.getMessage()); } requestObserver.onCompleted(); if (!latch.await(1, TimeUnit.MINUTES)) { logger.warning(\"request cannot finish within 1 minute\"); } } Though it looks confused in the beginning since we have response as the parameter of uploadImage and get a request back which makes it conter-intuitive compared with createBook, it would help you to get it straight if you think about the meaning of streaming.\nWe are streaming the request to the server, which means we have multiple requests and we need something to handle them sequentially. Thus we need something might sound like request handler - which is exactly StreamObserver. In other words, uploadImage yield a request handler instead of one time response as createBook.\nWith this request handler, we just need pass in request till none. Therefore, we create StreamObserver by passing in a simple StreamObserver which also contains OnNext, OnError and OnCompleted (we will need fill the three methods as long as it is streaming connection).\nSince it is the response, we could just simply log the info. Next step, we should starting building these requests. We will build UploadImageRequest from either ImageInfo (from Image object) or ChunkData (from fileInputStream), and send them sequentially to the request handler.\nIn the end, we should just call onCompleted to shut down the streaming.\nAccordingly, we need revise createBook in client to upload images when creating book:\npublic void createBook(Book book) throws InterruptedException { CreateBookRequest request = CreateBookRequest.newBuilder().setBook(book).build(); CreateBookResponse response = CreateBookResponse.getDefaultInstance(); try { response = blockingStub.withDeadlineAfter(5, SECONDS).createBook(request); for (Image image : book.getImageList()) { new Thread( () -\u003e { try { uploadImage(book.getId(), image); } catch (InterruptedException e) { throw new RuntimeException(e); } } ).start(); } } catch (StatusRuntimeException e) { if (e.getStatus().getCode() == Status.Code.ALREADY_EXISTS) { logger.info(\"Book already exists\"); return; } } catch (Exception e) { logger.log(SEVERE, \"request failed \" + e.getMessage()); } logger.info(\"New book created: \\n\" + response.getId()); } For each image, we create a new thread to upload the image. The standard way is to use a Executor Pool instead of starting a new thread whatever. But bear with me since the meat is gRPC here.\nIt is a lot to take from serverice and client. Now it is the easist part, server. But before that, we prob need implement image store for us since we would need it in our server implementation. Same as book store, we will implement the image store in disk. To be clear, the image itself is saved in local like a blob store and the path will be saved in memory. So we can easily access the image for a book from the book store.\npackage today.ihelio.learngrpc; import today.ihelio.grpc.Image; import today.ihelio.grpc.ImageInfo; import java.io.ByteArrayOutputStream; import java.io.FileNotFoundException; import java.io.FileOutputStream; import java.io.IOException; import java.util.UUID; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.ConcurrentMap; import static com.google.protobuf.util.Timestamps.fromMillis; import static java.lang.System.currentTimeMillis; /** * @author helio * @date 2022/9/4 * @package today.ihelio.learngrpc */public class DiskImageStore implements ImageStore{ ConcurrentMap\u003cString, ConcurrentMap\u003cString,Image\u003e\u003e store; private String imageFolder; public DiskImageStore(String imageFolder) { this.store = new ConcurrentHashMap\u003c\u003e(); this.imageFolder = imageFolder; } @Override public String Save(String bookID, ImageInfo info, ByteArrayOutputStream imageData) throws IOException { String imageName = info.getFileName(); String imageID = UUID.nameUUIDFromBytes(imageName.getBytes()).toString(); if (store.containsKey(bookID)) { if (store.get(bookID).containsKey(imageID)) { throw new AlreadyExistsException(\"image %s already existed for book %s\".formatted(imageName, bookID)); } } else { store.put(bookID, new ConcurrentHashMap\u003c\u003e()); } String imagePath = String.format(\"%s/%s\", imageFolder, imageName); FileOutputStream fileOutputStream = new FileOutputStream(imagePath); imageData.writeTo(fileOutputStream); fileOutputStream.close(); Image image = Image.newBuilder() .setId(imageID) .setFilePath(imagePath) .setUploadedAt(fromMillis(currentTimeMillis())) .build(); store.get(bookID).put(imageID, image); return image.getId(); } } The DiskImageStore is simple, since we are passing ByteArrayOutputStream, we just need create the image path and save the image to the path, and update the InMemoryStore.\nFor server, we would need revise it a bit since BookService requires DiskImageStore now but the most remain the same.\npackage today.ihelio.learngrpc; import io.grpc.Server; import io.grpc.ServerBuilder; import io.grpc.protobuf.services.ProtoReflectionService; import java.io.IOException; import java.util.concurrent.TimeUnit; import java.util.logging.Logger; /** * @author helio * @date 2022/9/3 * @package today.ihelio.learngrpc */public class BookServer { private final Logger logger = Logger.getLogger(BookServer.class.getName()); private BookService bookService; private final int port; private final Server server; public BookServer(int port, BookStore bookStore, ImageStore imageStore) { this(ServerBuilder.forPort(port), port, bookStore, imageStore); } public BookServer(ServerBuilder serverBuilder, int port, BookStore bookStore, ImageStore imageStore) { this.port = port; this.bookService = new BookService(bookStore, imageStore); this.server = serverBuilder.addService(bookService) .addService(ProtoReflectionService.newInstance()) .build(); } public void start() throws IOException { server.start(); logger.info(\"Book server started on port \" + port); Runtime.getRuntime().addShutdownHook(new Thread(){ @Override public void run() { System.err.println(\"shutdown gRPC server because JVM shuts down\"); try { BookServer.this.stop(); } catch (InterruptedException e) { e.printStackTrace(); } System.err.println(\"server shutdown\"); } }); } public void stop() throws InterruptedException{ if (server != null) { server.shutdown().awaitTermination(30, TimeUnit.SECONDS); } } private void blockUntilShutdown() throws InterruptedException { if (server != null) { server.awaitTermination(); } } public static void main(String[] args) throws IOException, InterruptedException{ InMemoryBookStore inMemoryBookStore = new InMemoryBookStore(); DiskImageStore diskImageStore = new DiskImageStore(\"src/main/resources/images_destination\"); BookServer server = new BookServer(9080, inMemoryBookStore, diskImageStore); server.start(); server.blockUntilShutdown(); } } Let’s wrap up the client streaming in gRPC:\nWe need update proto to include necessay message and service Implement the core logic in the service, client and other revisions needed What we implement is a request handler, not a single request-response function Next chaper will introduce server streaming connection which has a lot in common with client streaming.\nThe complete project can be found here.\n",
  "wordCount" : "1656",
  "inLanguage": "en",
  "image": "//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished": "2023-09-16T16:17:15-04:00",
  "dateModified": "2023-09-16T16:17:15-04:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "//localhost:1313/posts/2023/grpc-tutorial---4/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "iHelio",
    "logo": {
      "@type": "ImageObject",
      "url": "//localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//localhost:1313/" accesskey="h" title="Home (Alt + H)">
                <img src="//localhost:1313/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="//localhost:1313/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="//localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="//localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      gRPC tutorial - 4: Client Streaming
    </h1>
    <div class="post-meta"><span title='2023-09-16 16:17:15 -0400 EDT'>September 16, 2023</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1656 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/ydeng11/ihelio/tree/main/content/posts/2023/gRPC%20tutorial%20-%204.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> 
  <div class="post-content"><p>We will implement a function to upload image when we create the books like the cover and something else. And we would split the image into chunks and we upload them chunk by chunk until all data are transfered. As we defined earlier in the proto, we could have multiple images for one book. So we will need a function called <code>uploadImage</code> and uploade all images one by one.</p>
<p>Let&rsquo;s start with the proto of image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kn">package</span> <span class="nn">book</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">option</span> <span class="n">java_multiple_files</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">option</span> <span class="n">java_package</span> <span class="o">=</span> <span class="s">&#34;today.ihelio.grpc&#34;</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">import</span> <span class="s">&#34;google/protobuf/timestamp.proto&#34;</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">Image</span> <span class="p">{</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">file_path</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="n">google.protobuf.Timestamp</span> <span class="n">uploaded_at</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>We create an <code>Image</code> message which has four fields: image id, file path in local, size and timestamp. This will be used on server side to contain the image info when it receives an image from client.</p>
<p>Then we need define our request and response for client.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="kd">message</span> <span class="nc">UploadImageRequest</span> <span class="p">{</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">oneof</span> <span class="n">data</span> <span class="p">{</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="n">ImageInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="kt">bytes</span> <span class="n">chunk_data</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="p">}</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">ImageInfo</span> <span class="p">{</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">book_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">image_type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">file_name</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">UploadImageResponse</span> <span class="p">{</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">uint32</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">file_path</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>We define an <code>ImageInfo</code> message which will contain book_id it associates with, image type and name. Thus the <code>UploadImageRequest</code> would upload the info to the server in addition to the image itself. Then the <code>UploadImageResponse</code> would return the server-generated id, size and file path at server.</p>
<p>Thus the <code>BookService</code> now is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="kd">service</span> <span class="n">BookService</span> <span class="p">{</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">rpc</span> <span class="n">CreateBook</span><span class="p">(</span><span class="n">CreateBookRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CreateBookResponse</span><span class="p">)</span> <span class="p">{};</span>  <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">rpc</span> <span class="n">UploadImage</span><span class="p">(</span><span class="n">stream</span> <span class="n">UploadImageRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">UploadImageResponse</span><span class="p">)</span> <span class="p">{};</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>Now we should turn to the implmentation of <code>UploadImage</code> in server, client and service. Since we already have them, we will now build upon them.</p>
<p><code>BookService</code> always comes the first since it is our core logic. With core logic built up, it is easy to implement server and client for it. And it is easy to add new feature to <code>BookService</code> given we just need use the auto code generation function in Intellij and insert the <code>Override Method</code> which is <code>uploadImage</code> in this case.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">UploadImageRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">uploadImage</span><span class="p">(</span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">UploadImageResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseObserver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">UploadImageRequest</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">bookID</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">private</span><span class="w"> </span><span class="n">ImageInfo</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">private</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">imageData</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onNext</span><span class="p">(</span><span class="n">UploadImageRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getDataCase</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UploadImageRequest</span><span class="p">.</span><span class="na">DataCase</span><span class="p">.</span><span class="na">INFO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getInfo</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;receive image info:\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">bookID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">getBookId</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">imageData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Book</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bookStore</span><span class="p">.</span><span class="na">findBook</span><span class="p">(</span><span class="n">bookID</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">responseObserver</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">Status</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="p">.</span><span class="na">withDescription</span><span class="p">(</span><span class="s">&#34;Book not found&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="p">.</span><span class="na">asRuntimeException</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ByteString</span><span class="w"> </span><span class="n">chunkData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getChunkData</span><span class="p">();</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">imageData</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;image info wasn&#39;t sent before&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">responseObserver</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">Status</span><span class="p">.</span><span class="na">INVALID_ARGUMENT</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="p">.</span><span class="na">withDescription</span><span class="p">(</span><span class="s">&#34;image info wasn&#39;t sent before&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="p">.</span><span class="na">asRuntimeException</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">chunkData</span><span class="p">.</span><span class="na">writeTo</span><span class="p">(</span><span class="n">imageData</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">responseObserver</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">Status</span><span class="p">.</span><span class="na">INTERNAL</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">.</span><span class="na">withDescription</span><span class="p">(</span><span class="s">&#34;cannot write chunk data: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="p">.</span><span class="na">asRuntimeException</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">logger</span><span class="p">.</span><span class="na">warning</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCompleted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">imageID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">imageSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imageData</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">imageID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imageStore</span><span class="p">.</span><span class="na">Save</span><span class="p">(</span><span class="n">bookID</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">imageData</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">UploadImageResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UploadImageResponse</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">imageID</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">setSize</span><span class="p">(</span><span class="n">imageSize</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">responseObserver</span><span class="p">.</span><span class="na">onNext</span><span class="p">(</span><span class="n">response</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">responseObserver</span><span class="p">.</span><span class="na">onCompleted</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Same as alwasys, the key is to return what we need return which is <code>StreamObserver&lt;UploadImageRequest&gt;</code>, thus we could directly return a new <code>StreamObserver&lt;UploadImageRequest&gt;</code> and put our logic inside the code block.</p>
<p>And there are three function we need fill:</p>
<ul>
<li>OnNext: continously handle the next request
<ul>
<li>Create <code>ByteArrayOutputStream</code> to save the image data</li>
<li>Check if the upload data type is <code>ImageInfo</code></li>
<li>If yes, we store the image info, otherwise we write the data chunk to <code>ByteArrayOutputStream</code></li>
</ul>
</li>
<li>OnError:
<ul>
<li>Handle the error</li>
</ul>
</li>
<li>OnCompleted:
<ul>
<li>Save the image to our image store (we will talk about it later)</li>
<li>Send out the response</li>
<li>Close the response</li>
</ul>
</li>
</ul>
<p>After we have the logic ready, we then can start client and server implementation.</p>
<p>The following snippet is the implmenetation of <code>uploadImage</code> from client:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">uploadImage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bookID</span><span class="p">,</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">image</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">latch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// we use asyncStub instead of blockingStub for streaming connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">UploadImageRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestObserver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asyncStub</span><span class="p">.</span><span class="na">withDeadlineAfter</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">SECONDS</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">uploadImage</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">UploadImageResponse</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onNext</span><span class="p">(</span><span class="n">UploadImageResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;receive response:\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">SEVERE</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;upload failed: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCompleted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;image uploaded&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileInputStream</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">imagePath</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">imagePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fileInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">imagePath</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">FileNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">SEVERE</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;cannot read image file: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">imageType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imagePath</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">imagePath</span><span class="p">.</span><span class="na">lastIndexOf</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imagePath</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">imagePath</span><span class="p">.</span><span class="na">lastIndexOf</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ImageInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImageInfo</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">setBookId</span><span class="p">(</span><span class="n">bookID</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">setImageType</span><span class="p">(</span><span class="n">imageType</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">setFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">UploadImageRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UploadImageRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setInfo</span><span class="p">(</span><span class="n">info</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">requestObserver</span><span class="p">.</span><span class="na">onNext</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;send image info:\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileInputStream</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latch</span><span class="p">.</span><span class="na">getCount</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UploadImageRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setChunkData</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">requestObserver</span><span class="p">.</span><span class="na">onNext</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">SEVERE</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;unexpected error: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">requestObserver</span><span class="p">.</span><span class="na">onCompleted</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">latch</span><span class="p">.</span><span class="na">await</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">warning</span><span class="p">(</span><span class="s">&#34;request cannot finish within 1 minute&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Though it looks confused in the beginning since we have <code>response</code> as the parameter of <code>uploadImage</code> and get a <code>request</code> back which makes it conter-intuitive compared with <code>createBook</code>, it would help you to get it straight if you think about the meaning of streaming.</p>
<p>We are streaming the request to the server, which means we have multiple requests and we need something to handle them sequentially. Thus we need something might sound like request handler - which is exactly <code>StreamObserver&lt;UploadImageRequest&gt;</code>. In other words, <code>uploadImage</code> yield a request handler instead of one time response as <code>createBook</code>.</p>
<p>With this request handler, we just need pass in request till none. Therefore, we create <code>StreamObserver&lt;UploadImageRequest&gt;</code> by passing in a simple <code>StreamObserver&lt;UploadImageResponse&gt;</code> which also contains OnNext, OnError and OnCompleted (we will need fill the three methods as long as it is streaming connection).</p>
<p>Since it is the response, we could just simply log the info. Next step, we should starting building these requests. We will build <code>UploadImageRequest</code> from either <code>ImageInfo</code> (from <code>Image</code> object) or <code>ChunkData</code> (from <code>fileInputStream</code>), and send them sequentially to the request handler.</p>
<p>In the end, we should just call <code>onCompleted</code> to shut down the streaming.</p>
<p>Accordingly, we need revise <code>createBook</code> in client to upload images when creating book:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">createBook</span><span class="p">(</span><span class="n">Book</span><span class="w"> </span><span class="n">book</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreateBookRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateBookRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setBook</span><span class="p">(</span><span class="n">book</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreateBookResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateBookResponse</span><span class="p">.</span><span class="na">getDefaultInstance</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockingStub</span><span class="p">.</span><span class="na">withDeadlineAfter</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">SECONDS</span><span class="p">).</span><span class="na">createBook</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Image</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="na">getImageList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">uploadImage</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">image</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">StatusRuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getStatus</span><span class="p">().</span><span class="na">getCode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Status</span><span class="p">.</span><span class="na">Code</span><span class="p">.</span><span class="na">ALREADY_EXISTS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Book already exists&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">SEVERE</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;request failed &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;New book created: \n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>For each image, we create a new thread to upload the image. <strong>The standard way is to use a Executor Pool instead of starting a new thread whatever.</strong> But bear with me since the meat is gRPC here.</p>
<p>It is a lot to take from serverice and client. Now it is the easist part, server. But before that, we prob need implement image store for us since we would need it in our server implementation. Same as book store, we will implement the image store in disk. To be clear, the image itself is saved in local like a blob store and the path will be saved in memory. So we can easily access the image for a book from the book store.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">today.ihelio.learngrpc</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">today.ihelio.grpc.Image</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">today.ihelio.grpc.ImageInfo</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileNotFoundException</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentMap</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import static</span><span class="w"> </span><span class="nn">com.google.protobuf.util.Timestamps.fromMillis</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import static</span><span class="w"> </span><span class="nn">java.lang.System.currentTimeMillis</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**  
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author helio  
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @date 2022/9/4  
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @package today.ihelio.learngrpc  
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DiskImageStore</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ImageStore</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">Image</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">store</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">imageFolder</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">DiskImageStore</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">imageFolder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">imageFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imageFolder</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">Save</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bookID</span><span class="p">,</span><span class="w"> </span><span class="n">ImageInfo</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">imageData</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">imageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">getFileName</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">imageID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">nameUUIDFromBytes</span><span class="p">(</span><span class="n">imageName</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()).</span><span class="na">toString</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">bookID</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bookID</span><span class="p">).</span><span class="na">containsKey</span><span class="p">(</span><span class="n">imageID</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AlreadyExistsException</span><span class="p">(</span><span class="s">&#34;image %s already existed for book %s&#34;</span><span class="p">.</span><span class="na">formatted</span><span class="p">(</span><span class="n">imageName</span><span class="p">,</span><span class="w"> </span><span class="n">bookID</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">store</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">bookID</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">imagePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%s/%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">imageFolder</span><span class="p">,</span><span class="w"> </span><span class="n">imageName</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fileOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">imagePath</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">imageData</span><span class="p">.</span><span class="na">writeTo</span><span class="p">(</span><span class="n">fileOutputStream</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fileOutputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Image</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Image</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">imageID</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setFilePath</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setUploadedAt</span><span class="p">(</span><span class="n">fromMillis</span><span class="p">(</span><span class="n">currentTimeMillis</span><span class="p">()))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">store</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bookID</span><span class="p">).</span><span class="na">put</span><span class="p">(</span><span class="n">imageID</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The <code>DiskImageStore</code> is simple, since we are passing <code>ByteArrayOutputStream</code>, we just need create the image path and save the image to the path, and update the <code>InMemoryStore</code>.</p>
<p>For server, we would need revise it a bit since <code>BookService</code> requires <code>DiskImageStore</code> now but the most remain the same.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">today.ihelio.learngrpc</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">io.grpc.Server</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">io.grpc.ServerBuilder</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">io.grpc.protobuf.services.ProtoReflectionService</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**  
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author helio  
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @date 2022/9/3  
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @package today.ihelio.learngrpc  
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BookServer</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">BookServer</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BookService</span><span class="w"> </span><span class="n">bookService</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">BookServer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">BookStore</span><span class="w"> </span><span class="n">bookStore</span><span class="p">,</span><span class="w"> </span><span class="n">ImageStore</span><span class="w"> </span><span class="n">imageStore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">ServerBuilder</span><span class="p">.</span><span class="na">forPort</span><span class="p">(</span><span class="n">port</span><span class="p">),</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">bookStore</span><span class="p">,</span><span class="w"> </span><span class="n">imageStore</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">BookServer</span><span class="p">(</span><span class="n">ServerBuilder</span><span class="w"> </span><span class="n">serverBuilder</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">BookStore</span><span class="w"> </span><span class="n">bookStore</span><span class="p">,</span><span class="w"> </span><span class="n">ImageStore</span><span class="w"> </span><span class="n">imageStore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">bookService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BookService</span><span class="p">(</span><span class="n">bookStore</span><span class="p">,</span><span class="w"> </span><span class="n">imageStore</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serverBuilder</span><span class="p">.</span><span class="na">addService</span><span class="p">(</span><span class="n">bookService</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">addService</span><span class="p">(</span><span class="n">ProtoReflectionService</span><span class="p">.</span><span class="na">newInstance</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Book server started on port &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">addShutdownHook</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(){</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;shutdown gRPC server because JVM shuts down&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">BookServer</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;server shutdown&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">server</span><span class="p">.</span><span class="na">shutdown</span><span class="p">().</span><span class="na">awaitTermination</span><span class="p">(</span><span class="n">30</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blockUntilShutdown</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">server</span><span class="p">.</span><span class="na">awaitTermination</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InMemoryBookStore</span><span class="w"> </span><span class="n">inMemoryBookStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryBookStore</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DiskImageStore</span><span class="w"> </span><span class="n">diskImageStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DiskImageStore</span><span class="p">(</span><span class="s">&#34;src/main/resources/images_destination&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BookServer</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BookServer</span><span class="p">(</span><span class="n">9080</span><span class="p">,</span><span class="w"> </span><span class="n">inMemoryBookStore</span><span class="p">,</span><span class="w"> </span><span class="n">diskImageStore</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">server</span><span class="p">.</span><span class="na">blockUntilShutdown</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Let&rsquo;s wrap up the client streaming in gRPC:</p>
<ol>
<li>We need update proto to include necessay message and service</li>
<li>Implement the core logic in the service, client and other revisions needed
<ol>
<li>What we implement is a request handler, not a single request-response function</li>
</ol>
</li>
</ol>
<p>Next chaper will introduce server streaming connection which has a lot in common with client streaming.</p>
<p>The complete project can be found <a href="https://github.com/ydeng11/gRPC-tutorial/tree/main">here</a>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="//localhost:1313/posts/2023/grpc-tutorial---3/">
    <span class="title">« Prev</span>
    <br>
    <span>gRPC tutorial - 3: Unary Call</span>
  </a>
  <a class="next" href="//localhost:1313/posts/2023/grpc-tutorial---5/">
    <span class="title">Next »</span>
    <br>
    <span>gRPC tutorial - 5: Server Streaming</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on x"
            href="https://x.com/intent/tweet/?text=gRPC%20tutorial%20-%204%3a%20Client%20Streaming&amp;url=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f&amp;title=gRPC%20tutorial%20-%204%3a%20Client%20Streaming&amp;summary=gRPC%20tutorial%20-%204%3a%20Client%20Streaming&amp;source=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on reddit"
            href="https://reddit.com/submit?url=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f&title=gRPC%20tutorial%20-%204%3a%20Client%20Streaming">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on facebook"
            href="https://facebook.com/sharer/sharer.php?u=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on whatsapp"
            href="https://api.whatsapp.com/send?text=gRPC%20tutorial%20-%204%3a%20Client%20Streaming%20-%20%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on telegram"
            href="https://telegram.me/share/url?text=gRPC%20tutorial%20-%204%3a%20Client%20Streaming&amp;url=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share gRPC tutorial - 4: Client Streaming on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=gRPC%20tutorial%20-%204%3a%20Client%20Streaming&u=%2f%2flocalhost%3a1313%2fposts%2f2023%2fgrpc-tutorial---4%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ihelio-today" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="//localhost:1313/">iHelio</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
